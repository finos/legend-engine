###Pure
import meta::external::format::openapi::metamodel::*;
import meta::legend::service::metamodel::*;
import meta::external::format::openapi::test::*;
import meta::pure::mapping::*;
import meta::external::format::openapi::generation::*;

Class meta::external::format::openapi::test::Person
{
  firstName : String[1];
  lastName  : String[1];
  age: Integer[1];
}


function {doc.doc = 'Legend openapi test simple service'} meta::external::format::openapi::test::simpleService():Service[1]
{
   ^Service
      (
         pattern = '/service/testOpenApi',
         owners = ['dummy'],
         documentation = 'dummy description',
         autoActivateUpdates = true,
         execution = ^PureSingleExecution
                     (
                        func = {|Person.all()->filter(p | $p.firstName->in(['A', 'B', 'C', 'D', 'E']))->project(col(p|$p.firstName, 'firstName'))},
                        mapping = personMapping,
                        runtime = []
                     ),
         test = ^SingleExecutionTest
                 (
                  data = 'default\n'+
                         'personTable\n'+
                         'id,firstName,lastName,age\n'+
                         '1,A,Z,23\n'+
                         '\n\n\n',
                  asserts = [
                              ^meta::legend::service::metamodel::TestContainer(
                                 parametersValues = [],
                                 assert = {res:Result<Any|*>[1]|$res.values->cast(@TabularDataSet).rows->map(r|$r.getString('firstName'))->sort() == ['A', 'B', 'C', 'D', 'E']}
                              )
                            ]
                 )
      );
}


function <<test.Test>> meta::external::format::openapi::test::testServiceShouldReturnCorrectOpenapiString():Boolean[1] {
  let openapi = simpleService()->serviceToOpenApi(^Server(url='test'));
  let expected = '{"openapi":"3.0.0","info":{"title":"Legend API","version":"1.0.0"},"servers":[{"url":"test"}],"paths":{"/service/testOpenApi":{"get":{"tags":["definition"],"responses":{"200":{"description":"success","content":{"application/json":{"schema":{"$ref":"#/components/schemas/TabularDataSet"}}}}}},"post":{"tags":["definition"],"responses":{"200":{"description":"success","content":{"application/json":{"schema":{"$ref":"#/components/schemas/TabularDataSet"}}}}}}}},"components":{"schemas":{"FloatNumberProperty":{"type":"object","properties":{"null_value":{"type":"float"},"type":{"type":"string"},"_pure_protocol_type":{"type":"string"}}},"LongRangeProperty":{"type":"object","properties":{"type":{"type":"string"},"_pure_protocol_type":{"type":"string"}}},"StoredScriptId":{"type":"object","properties":{"id":{"type":"string"},"_pure_protocol_type":{"type":"string"}}},"Map":{"type":"object","properties":{}},"TDSColumn":{"type":"object","properties":{"sourceDataType":{"$ref":"#/components/schemas/Any"},"enumMappingId":{"type":"string"},"name":{"type":"string"},"documentation":{"type":"string"},"offset":{"type":"integer"},"type":{"$ref":"#/components/schemas/DataType"}}},"ShapeProperty":{"type":"object","properties":{"ignore_malformed":{"type":"boolean"},"orientation":{"type":"string","enum":["right","left"]},"coerce":{"type":"boolean"},"ignore_z_value":{"type":"boolean"},"type":{"type":"string"},"_pure_protocol_type":{"type":"string"}}},"MultiplicityValue":{"type":"object","properties":{"value":{"type":"integer"}}},"TDSRow":{"type":"object","properties":{"values":{"type":"array","items":[{"$ref":"#/components/schemas/Any"}]},"parent":{"$ref":"#/components/schemas/TabularDataSet"}}},"Profile":{"type":"object","properties":{"p_stereotypes":{"type":"array","items":[{"$ref":"#/components/schemas/Stereotype"}]},"p_tags":{"type":"array","items":[{"$ref":"#/components/schemas/Tag"}]}}},"DateProperty":{"type":"object","properties":{"index":{"type":"boolean"},"ignore_malformed":{"type":"boolean"},"locale":{"type":"string"},"null_value":{"type":"string"},"boost":{"type":"float"},"fielddata":{"$ref":"#/components/schemas/NumericFielddata"},"format":{"type":"string"},"precision_step":{"type":"integer"},"type":{"type":"string"},"_pure_protocol_type":{"type":"string"}}},"DenseVectorIndexOptions":{"type":"object","properties":{"ef_construction":{"type":"integer"},"m":{"type":"integer"},"type":{"type":"string"}}},"Multiplicity":{"type":"object","properties":{"lowerBound":{"$ref":"#/components/schemas/MultiplicityValue"},"multiplicityParameter":{"type":"string"},"upperBound":{"$ref":"#/components/schemas/MultiplicityValue"}}},"TaggedValue":{"type":"object","properties":{"tag":{"$ref":"#/components/schemas/Tag"},"value":{"type":"string"}}},"IpProperty":{"type":"object","properties":{"index":{"type":"boolean"},"ignore_malformed":{"type":"boolean"},"null_value":{"type":"string"},"boost":{"type":"float"},"type":{"type":"string"},"_pure_protocol_type":{"type":"string"}}},"PercolatorProperty":{"type":"object","properties":{"type":{"type":"string"},"_pure_protocol_type":{"type":"string"}}},"NestedProperty":{"type":"object","properties":{"enabled":{"type":"boolean"},"include_in_parent":{"type":"boolean"},"include_in_root":{"type":"boolean"},"type":{"type":"string"},"_pure_protocol_type":{"type":"string"}}},"TableTDS":{"type":"object","properties":{"table":{"$ref":"#/components/schemas/NamedRelation"}}},"ByteNumberProperty":{"type":"object","properties":{"null_value":{"type":"float"},"type":{"type":"string"},"_pure_protocol_type":{"type":"string"}}},"PointProperty":{"type":"object","properties":{"ignore_malformed":{"type":"boolean"},"ignore_z_value":{"type":"boolean"},"null_value":{"type":"string"},"type":{"type":"string"},"_pure_protocol_type":{"type":"string"}}},"IntegerNumberProperty":{"type":"object","properties":{"null_value":{"type":"integer"},"type":{"type":"string"},"_pure_protocol_type":{"type":"string"}}},"ShortNumberProperty":{"type":"object","properties":{"null_value":{"type":"float"},"type":{"type":"string"},"_pure_protocol_type":{"type":"string"}}},"DataType":{"type":"object","properties":{}},"FloatRangeProperty":{"type":"object","properties":{"type":{"type":"string"},"_pure_protocol_type":{"type":"string"}}},"Generalization":{"type":"object","properties":{"specific":{"$ref":"#/components/schemas/Type"},"general":{"$ref":"#/components/schemas/GenericType"}}},"Property":{"type":"object","properties":{"text":{"$ref":"#/components/schemas/TextProperty"},"keyword":{"$ref":"#/components/schemas/KeywordProperty"},"wildcard":{"$ref":"#/components/schemas/WildcardProperty"},"alias":{"$ref":"#/components/schemas/FieldAliasProperty"},"date_nanos":{"$ref":"#/components/schemas/DateNanosProperty"},"integer":{"$ref":"#/components/schemas/IntegerNumberProperty"},"double_range":{"$ref":"#/components/schemas/DoubleRangeProperty"},"join":{"$ref":"#/components/schemas/JoinProperty"},"shape":{"$ref":"#/components/schemas/ShapeProperty"},"date_range":{"$ref":"#/components/schemas/DateRangeProperty"},"ip":{"$ref":"#/components/schemas/IpProperty"},"_double":{"$ref":"#/components/schemas/DoubleNumberProperty"},"rank_feature":{"$ref":"#/components/schemas/RankFeatureProperty"},"_boolean":{"$ref":"#/components/schemas/BooleanProperty"},"point":{"$ref":"#/components/schemas/PointProperty"},"aggregate_metric_double":{"$ref":"#/components/schemas/AggregateMetricDoubleProperty"},"flattened":{"$ref":"#/components/schemas/FlattenedProperty"},"search_as_you_type":{"$ref":"#/components/schemas/SearchAsYouTypeProperty"},"match_only_text":{"$ref":"#/components/schemas/MatchOnlyTextProperty"},"histogram":{"$ref":"#/components/schemas/HistogramProperty"},"binary":{"$ref":"#/components/schemas/BinaryProperty"},"long_range":{"$ref":"#/components/schemas/LongRangeProperty"},"rank_features":{"$ref":"#/components/schemas/RankFeaturesProperty"},"geo_shape":{"$ref":"#/components/schemas/GeoShapeProperty"},"ip_range":{"$ref":"#/components/schemas/IpRangeProperty"},"scaled_float":{"$ref":"#/components/schemas/ScaledFloatNumberProperty"},"nested":{"$ref":"#/components/schemas/NestedProperty"},"object":{"$ref":"#/components/schemas/ObjectProperty"},"float_range":{"$ref":"#/components/schemas/FloatRangeProperty"},"version":{"$ref":"#/components/schemas/VersionProperty"},"date":{"$ref":"#/components/schemas/DateProperty"},"_byte":{"$ref":"#/components/schemas/ByteNumberProperty"},"completion":{"$ref":"#/components/schemas/CompletionProperty"},"murmur3":{"$ref":"#/components/schemas/Murmur3HashProperty"},"constant_keyword":{"$ref":"#/components/schemas/ConstantKeywordProperty"},"percolator":{"$ref":"#/components/schemas/PercolatorProperty"},"_float":{"$ref":"#/components/schemas/FloatNumberProperty"},"half_float":{"$ref":"#/components/schemas/HalfFloatNumberProperty"},"_long":{"$ref":"#/components/schemas/LongNumberProperty"},"dense_vector":{"$ref":"#/components/schemas/DenseVectorProperty"},"token_count":{"$ref":"#/components/schemas/TokenCountProperty"},"_short":{"$ref":"#/components/schemas/ShortNumberProperty"},"unsigned_long":{"$ref":"#/components/schemas/UnsignedLongNumberProperty"},"integer_range":{"$ref":"#/components/schemas/IntegerRangeProperty"},"geo_point":{"$ref":"#/components/schemas/GeoPointProperty"}}},"UnsignedLongNumberProperty":{"type":"object","properties":{"null_value":{"type":"float"},"type":{"type":"string"},"_pure_protocol_type":{"type":"string"}}},"TypeParameter":{"type":"object","properties":{"lowerBound":{"$ref":"#/components/schemas/GenericType"},"name":{"type":"string"},"contravariant":{"type":"boolean"},"upperBound":{"$ref":"#/components/schemas/GenericType"}}},"KeywordProperty":{"type":"object","properties":{"index":{"type":"boolean"},"split_queries_on_whitespace":{"type":"boolean"},"null_value":{"type":"string"},"boost":{"type":"float"},"index_options":{"type":"string","enum":["docs","freqs","positions","offsets"]},"norms":{"type":"boolean"},"normalizer":{"type":"string"},"type":{"type":"string"},"eager_global_ordinals":{"type":"boolean"},"_pure_protocol_type":{"type":"string"}}},"JoinProperty":{"type":"object","properties":{"relations":{"$ref":"#/components/schemas/Map"},"type":{"type":"string"},"_pure_protocol_type":{"type":"string"}}},"ObjectProperty":{"type":"object","properties":{"enabled":{"type":"boolean"},"type":{"type":"string"},"_pure_protocol_type":{"type":"string"}}},"RelationalOperationElement":{"type":"object","properties":{}},"IpRangeProperty":{"type":"object","properties":{"type":{"type":"string"},"_pure_protocol_type":{"type":"string"}}},"AnnotatedElement":{"type":"object","properties":{}},"ReferenceUsage":{"type":"object","properties":{"propertyName":{"type":"string"},"owner":{"$ref":"#/components/schemas/Any"},"offset":{"type":"integer"}}},"TabularDataSet":{"type":"object","properties":{"columns":{"type":"array","items":[{"$ref":"#/components/schemas/TDSColumn"}]},"rows":{"type":"array","items":[{"$ref":"#/components/schemas/TDSRow"}]}}},"Tag":{"type":"object","properties":{}},"TextIndexPrefixes":{"type":"object","properties":{"max_chars":{"type":"integer"},"min_chars":{"type":"integer"}}},"ScaledFloatNumberProperty":{"type":"object","properties":{"coerce":{"type":"boolean"},"null_value":{"type":"float"},"scaling_factor":{"type":"float"},"type":{"type":"string"},"_pure_protocol_type":{"type":"string"}}},"VersionProperty":{"type":"object","properties":{"type":{"type":"string"},"_pure_protocol_type":{"type":"string"}}},"FielddataFrequencyFilter":{"type":"object","properties":{"max":{"type":"float"},"min_segment_size":{"type":"integer"},"min":{"type":"float"}}},"FieldAliasProperty":{"type":"object","properties":{"path":{"type":"string"},"type":{"type":"string"},"_pure_protocol_type":{"type":"string"}}},"GeoShapeProperty":{"type":"object","properties":{"ignore_malformed":{"type":"boolean"},"orientation":{"type":"string","enum":["right","left"]},"coerce":{"type":"boolean"},"ignore_z_value":{"type":"boolean"},"strategy":{"type":"string","enum":["recursive","term"]},"type":{"type":"string"},"_pure_protocol_type":{"type":"string"}}},"SuggestContext":{"type":"object","properties":{"precision":{"type":"string"},"name":{"type":"string"},"path":{"type":"string"},"type":{"type":"string"}}},"FlattenedProperty":{"type":"object","properties":{"index":{"type":"boolean"},"split_queries_on_whitespace":{"type":"boolean"},"null_value":{"type":"string"},"boost":{"type":"float"},"index_options":{"type":"string","enum":["docs","freqs","positions","offsets"]},"doc_values":{"type":"boolean"},"similarity":{"type":"string"},"depth_limit":{"type":"integer"},"type":{"type":"string"},"eager_global_ordinals":{"type":"boolean"},"_pure_protocol_type":{"type":"string"}}},"Script":{"type":"object","properties":{"inline":{"$ref":"#/components/schemas/InlineScript"},"stored":{"$ref":"#/components/schemas/StoredScriptId"}}},"Murmur3HashProperty":{"type":"object","properties":{"type":{"type":"string"},"_pure_protocol_type":{"type":"string"}}},"SetColumn":{"type":"object","properties":{}},"NumericFielddata":{"type":"object","properties":{"format":{"type":"string","enum":["array","disabled"]}}},"RankFeatureProperty":{"type":"object","properties":{"positive_score_impact":{"type":"boolean"},"type":{"type":"string"},"_pure_protocol_type":{"type":"string"}}},"CompletionProperty":{"type":"object","properties":{"max_input_length":{"type":"integer"},"preserve_separators":{"type":"boolean"},"search_analyzer":{"type":"string"},"analyzer":{"type":"string"},"contexts":{"type":"array","items":[{"$ref":"#/components/schemas/SuggestContext"}]},"preserve_position_increments":{"type":"boolean"},"type":{"type":"string"},"_pure_protocol_type":{"type":"string"}}},"InlineScript":{"type":"object","properties":{"source":{"type":"string"},"options":{"$ref":"#/components/schemas/Map"},"lang":{"$ref":"#/components/schemas/ScriptLanguage"},"_pure_protocol_type":{"type":"string"}}},"SearchAsYouTypeProperty":{"type":"object","properties":{"index":{"type":"boolean"},"search_analyzer":{"type":"string"},"analyzer":{"type":"string"},"index_options":{"type":"string","enum":["docs","freqs","positions","offsets"]},"max_shingle_size":{"type":"integer"},"norms":{"type":"boolean"},"search_quote_analyzer":{"type":"string"},"term_vector":{"type":"string","enum":["no","yes","with_offsets","with_positions","with_positions_offsets","with_positions_offsets_payloads","with_positions_payloads"]},"type":{"type":"string"},"_pure_protocol_type":{"type":"string"}}},"BooleanProperty":{"type":"object","properties":{"index":{"type":"boolean"},"null_value":{"type":"boolean"},"boost":{"type":"float"},"fielddata":{"$ref":"#/components/schemas/NumericFielddata"},"type":{"type":"string"},"_pure_protocol_type":{"type":"string"}}},"NamedRelation":{"type":"object","properties":{"name":{"type":"string"}}},"GeoHashLocation":{"type":"object","properties":{"geohash":{"type":"string"}}},"GeoPointProperty":{"type":"object","properties":{"ignore_malformed":{"type":"boolean"},"ignore_z_value":{"type":"boolean"},"null_value":{"$ref":"#/components/schemas/GeoLocation"},"type":{"type":"string"},"_pure_protocol_type":{"type":"string"}}},"HistogramProperty":{"type":"object","properties":{"ignore_malformed":{"type":"boolean"},"type":{"type":"string"},"_pure_protocol_type":{"type":"string"}}},"ConstantKeywordProperty":{"type":"object","properties":{"value":{"$ref":"#/components/schemas/Any"},"type":{"type":"string"},"_pure_protocol_type":{"type":"string"}}},"DoubleNumberProperty":{"type":"object","properties":{"null_value":{"type":"float"},"type":{"type":"string"},"_pure_protocol_type":{"type":"string"}}},"Person":{"type":"object","properties":{"lastName":{"type":"string"},"age":{"type":"integer"},"firstName":{"type":"string"}}},"MatchOnlyTextProperty":{"type":"object","properties":{"meta":{"$ref":"#/components/schemas/Map"},"copy_to":{"type":"string"},"fields":{"$ref":"#/components/schemas/Map"},"type":{"type":"string"}}},"DenseVectorProperty":{"type":"object","properties":{"index":{"type":"boolean"},"dims":{"type":"integer"},"index_options":{"$ref":"#/components/schemas/DenseVectorIndexOptions"},"similarity":{"type":"string"},"type":{"type":"string"},"_pure_protocol_type":{"type":"string"}}},"Any":{"type":"object","properties":{}},"Elasticsearch7StoreIndexMappingProperty":{"type":"object","properties":{"propertyName":{"type":"string"},"property":{"$ref":"#/components/schemas/Property"}}},"LongNumberProperty":{"type":"object","properties":{"null_value":{"type":"integer"},"type":{"type":"string"},"_pure_protocol_type":{"type":"string"}}},"GenericType":{"type":"object","properties":{"typeParameter":{"$ref":"#/components/schemas/TypeParameter"},"rawType":{"$ref":"#/components/schemas/Type"},"typeArguments":{"type":"array","items":[{"$ref":"#/components/schemas/GenericType"}]},"multiplicityArguments":{"type":"array","items":[{"$ref":"#/components/schemas/Multiplicity"}]},"referenceUsages":{"type":"array","items":[{"$ref":"#/components/schemas/ReferenceUsage"}]}}},"Type":{"type":"object","properties":{"generalizations":{"type":"array","items":[{"$ref":"#/components/schemas/Generalization"}]},"name":{"type":"string"},"specializations":{"type":"array","items":[{"$ref":"#/components/schemas/Generalization"}]}}},"HalfFloatNumberProperty":{"type":"object","properties":{"null_value":{"type":"float"},"type":{"type":"string"},"_pure_protocol_type":{"type":"string"}}},"IntegerRangeProperty":{"type":"object","properties":{"type":{"type":"string"},"_pure_protocol_type":{"type":"string"}}},"Store":{"type":"object","properties":{"includes":{"type":"array","items":[{"$ref":"#/components/schemas/Store"}]}}},"Elasticsearch7StoreIndexMapping":{"type":"object","properties":{"properties":{"type":"array","items":[{"$ref":"#/components/schemas/Elasticsearch7StoreIndexMappingProperty"}]},"indexName":{"type":"string"}}},"GeoLocation":{"type":"object","properties":{"text":{"type":"string"},"coords":{"type":"float"},"latlon":{"$ref":"#/components/schemas/LatLonGeoLocation"},"geohash":{"$ref":"#/components/schemas/GeoHashLocation"}}},"PackageableElement":{"type":"object","properties":{"package":{"$ref":"#/components/schemas/Package"},"referenceUsages":{"type":"array","items":[{"$ref":"#/components/schemas/ReferenceUsage"}]}}},"DoubleRangeProperty":{"type":"object","properties":{"type":{"type":"string"},"_pure_protocol_type":{"type":"string"}}},"Stereotype":{"type":"object","properties":{}},"ScriptLanguage":{"type":"object","properties":{"builtin":{"type":"string","enum":["painless","expression","mustache","java"]},"custom":{"type":"string"}}},"WildcardProperty":{"type":"object","properties":{"null_value":{"type":"string"},"type":{"type":"string"},"_pure_protocol_type":{"type":"string"}}},"DateNanosProperty":{"type":"object","properties":{"index":{"type":"boolean"},"ignore_malformed":{"type":"boolean"},"null_value":{"type":"string"},"boost":{"type":"float"},"format":{"type":"string"},"precision_step":{"type":"integer"},"type":{"type":"string"},"_pure_protocol_type":{"type":"string"}}},"TextProperty":{"type":"object","properties":{"index":{"type":"boolean"},"index_phrases":{"type":"boolean"},"search_analyzer":{"type":"string"},"analyzer":{"type":"string"},"index_options":{"type":"string","enum":["docs","freqs","positions","offsets"]},"norms":{"type":"boolean"},"term_vector":{"type":"string","enum":["no","yes","with_offsets","with_positions","with_positions_offsets","with_positions_offsets_payloads","with_positions_payloads"]},"type":{"type":"string"},"eager_global_ordinals":{"type":"boolean"},"fielddata_frequency_filter":{"$ref":"#/components/schemas/FielddataFrequencyFilter"},"position_increment_gap":{"type":"integer"},"boost":{"type":"float"},"fielddata":{"type":"boolean"},"index_prefixes":{"$ref":"#/components/schemas/TextIndexPrefixes"},"search_quote_analyzer":{"type":"string"},"_pure_protocol_type":{"type":"string"}}},"IndexTDS":{"type":"object","properties":{"index":{"$ref":"#/components/schemas/Elasticsearch7StoreIndexMapping"}}},"TokenCountProperty":{"type":"object","properties":{"index":{"type":"boolean"},"enable_position_increments":{"type":"boolean"},"null_value":{"type":"float"},"analyzer":{"type":"string"},"boost":{"type":"float"},"type":{"type":"string"},"_pure_protocol_type":{"type":"string"}}},"AggregateMetricDoubleProperty":{"type":"object","properties":{"default_metric":{"type":"string"},"metrics":{"type":"string"},"type":{"type":"string"},"_pure_protocol_type":{"type":"string"}}},"BinaryProperty":{"type":"object","properties":{"type":{"type":"string"},"_pure_protocol_type":{"type":"string"}}},"Package":{"type":"object","properties":{"children":{"type":"array","items":[{"$ref":"#/components/schemas/PackageableElement"}]}}},"RankFeaturesProperty":{"type":"object","properties":{"type":{"type":"string"},"_pure_protocol_type":{"type":"string"}}},"LatLonGeoLocation":{"type":"object","properties":{"lon":{"type":"float"},"lat":{"type":"float"}}},"DateRangeProperty":{"type":"object","properties":{"format":{"type":"string"},"type":{"type":"string"},"_pure_protocol_type":{"type":"string"}}}}}}';
  assert($expected->eq($openapi));
}






###Relational
Database meta::external::format::openapi::test::dbInc
(
    Table personTable (ID INT PRIMARY KEY, FIRSTNAME VARCHAR(200), LASTNAME VARCHAR(200), AGE INT)
)

###Mapping

import meta::external::format::openapi::test::*;
Mapping meta::external::format::openapi::test::personMapping
(
  Person : Relational
            {
                //~primaryKey([dbInc]default.personTable.ID, [dbInc]default.personTable.FIRSTNAME)
                scope([dbInc])
                (
                    firstName : personTable.FIRSTNAME,
                    age : personTable.AGE
                ),
                scope([dbInc]default.personTable)
                (
                    lastName : LASTNAME
                )
            }
)


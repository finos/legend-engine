// Copyright 2021 Goldman Sachs
//
// Licensed under the Apache License, Version 2.0 (the "License");
// you may not use this file except in compliance with the License.
// You may obtain a copy of the License at
//
//      http://www.apache.org/licenses/LICENSE-2.0
//
// Unless required by applicable law or agreed to in writing, software
// distributed under the License is distributed on an "AS IS" BASIS,
// WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
// See the License for the specific language governing permissions and
// limitations under the License.

###Pure
import meta::pure::runtime::*;
import meta::relational::mapping::*;
import meta::relational::tests::*;
import meta::relational::tests::milestoning::*;
import meta::relational::functions::asserts::*;

function <<test.Test>> meta::relational::tests::milestoning::snapshot::testQueryOnTemporalRoot():Boolean[1]
{
   let result = execute(|Product.all(%2015-08-26)->filter(p|$p.name == 'ProductName1')->project([p|$p.id],['id']), businessSnapshotMilestoningMap, testRuntime(), meta::relational::extension::relationalExtensions());
   assertEquals('select "root".id as "id" from ProductTableWithBusinessSnapshotMilestoning as "root" where "root".name = \'ProductName1\' and "root".snapshotDate = \'2015-08-26\'', $result->sqlRemoveFormatting());
   assertEquals(2, $result.values.rows.get('id'));
}

function <<test.Test>> meta::relational::tests::milestoning::snapshot::testQueryOnNonTemporalRootWithTemporalProperty():Boolean[1]
{
   let result = execute(|Order.all()->filter(o|$o.product(%2015-08-26).name == 'ProductName1')->project([o|$o.product(%2015-08-26).id],['id']), businessSnapshotMilestoningMap, testRuntime(), meta::relational::extension::relationalExtensions());
   assertEquals('select "producttablewithbusinesssnapshotmilestoning_0".id as "id" from OrderTable as "root" left outer join ProductTableWithBusinessSnapshotMilestoning as "producttablewithbusinesssnapshotmilestoning_0" on ("root".prodFk = "producttablewithbusinesssnapshotmilestoning_0".id and "producttablewithbusinesssnapshotmilestoning_0".snapshotDate = \'2015-08-26\') where "producttablewithbusinesssnapshotmilestoning_0".name = \'ProductName1\'', $result->sqlRemoveFormatting());
   assertEquals(2, $result.values.rows.get('id'));
}

function <<test.Test>> meta::relational::tests::milestoning::snapshot::testQueryWithPropagationOnTemporalRoot():Boolean[1]
{
   let result = execute(|Product.all(%2015-08-26)->filter(p|$p.classification.description == 'STOCK DESC-V2')->project([p|$p.classification.type],['type']), businessSnapshotMilestoningMap, testRuntime(), meta::relational::extension::relationalExtensions());
   assertEquals('select "productclassificationtablewithbusinesssnapshotmilestoning_0".type as "type" from ProductTableWithBusinessSnapshotMilestoning as "root" left outer join ProductClassificationTableWithBusinessSnapshotMilestoning as "productclassificationtablewithbusinesssnapshotmilestoning_0" on ("root".type = "productclassificationtablewithbusinesssnapshotmilestoning_0".type and "productclassificationtablewithbusinesssnapshotmilestoning_0".snapshotDate = \'2015-08-26\') where "productclassificationtablewithbusinesssnapshotmilestoning_0".type_description = \'STOCK DESC-V2\' and "root".snapshotDate = \'2015-08-26\'', $result->sqlRemoveFormatting());
   assertEquals('STOCK', $result.values.rows.get('type'));
}

function <<test.Test>> meta::relational::tests::milestoning::snapshot::testQueryWithPropagationOnNonTemporalRootWithTemporalProperty():Boolean[1]
{
   let result = execute(|Order.all()->filter(o|$o.product(%2015-08-26).classification.description == 'STOCK DESC-V2')->project([o|$o.product(%2015-08-26).classification.type],['type']), businessSnapshotMilestoningMap, testRuntime(), meta::relational::extension::relationalExtensions());
   assertEquals('select "productclassificationtablewithbusinesssnapshotmilestoning_1".type as "type" from OrderTable as "root" left outer join ProductTableWithBusinessSnapshotMilestoning as "producttablewithbusinesssnapshotmilestoning_0" on ("root".prodFk = "producttablewithbusinesssnapshotmilestoning_0".id and "producttablewithbusinesssnapshotmilestoning_0".snapshotDate = \'2015-08-26\') left outer join ProductClassificationTableWithBusinessSnapshotMilestoning as "productclassificationtablewithbusinesssnapshotmilestoning_0" on ("producttablewithbusinesssnapshotmilestoning_0".type = "productclassificationtablewithbusinesssnapshotmilestoning_0".type and "productclassificationtablewithbusinesssnapshotmilestoning_0".snapshotDate = \'2015-08-26\') left outer join (select "productclassificationtablewithbusinesssnapshotmilestoning_2".type as type from ProductClassificationTableWithBusinessSnapshotMilestoning as "productclassificationtablewithbusinesssnapshotmilestoning_2" where "productclassificationtablewithbusinesssnapshotmilestoning_2".snapshotDate = \'2015-08-26\') as "productclassificationtablewithbusinesssnapshotmilestoning_1" on ("producttablewithbusinesssnapshotmilestoning_0".type = "productclassificationtablewithbusinesssnapshotmilestoning_1".type) where "productclassificationtablewithbusinesssnapshotmilestoning_0".type_description = \'STOCK DESC-V2\'', $result->sqlRemoveFormatting());
   assertEquals('STOCK', $result.values.rows.get('type'));
}

function <<test.Test>> meta::relational::tests::milestoning::snapshot::testUnionQueryOnTemporalRoot():Boolean[1]
{
   let result = execute(|Product.all(%2015-08-26)->filter(p|$p.name == 'ProductName1')->project([p|$p.id],['id']), businessSnapshotMilestoningUnionMap, testRuntime(), meta::relational::extension::relationalExtensions());
   assertEquals('select "unionBase"."ProductTableWithBusinessSnapshotMilestoningid_ProductTableWithBusinessSnapshotMilestoningid" as "id" from (select "root".snapshotDate as "snapshotDate_0", null as "snapshotDate_1", "root".name as "ProductTableWithBusinessSnapshotMilestoningname_ProductTableWithBusinessSnapshotMilestoningname", "root".id as "pk_0_0", null as "pk_0_1", "root".id as "ProductTableWithBusinessSnapshotMilestoningid_ProductTableWithBusinessSnapshotMilestoningid" from ProductTableWithBusinessSnapshotMilestoning as "root" where "root".snapshotDate = \'2015-08-26\' UNION ALL select null as "snapshotDate_0", "root".snapshotDate as "snapshotDate_1", "root".name as "ProductTableWithBusinessSnapshotMilestoningname_ProductTableWithBusinessSnapshotMilestoningname", null as "pk_0_0", "root".id as "pk_0_1", "root".id as "ProductTableWithBusinessSnapshotMilestoningid_ProductTableWithBusinessSnapshotMilestoningid" from ProductTableWithBusinessSnapshotMilestoning as "root" where "root".snapshotDate = \'2015-08-26\') as "unionBase" where "unionBase"."ProductTableWithBusinessSnapshotMilestoningname_ProductTableWithBusinessSnapshotMilestoningname" = \'ProductName1\'', $result->sqlRemoveFormatting());
   assertEquals([2, 2], $result.values.rows.get('id'));
}

function <<test.Test>> meta::relational::tests::milestoning::snapshot::testUnionQueryOnNonTemporalRootWithTemporalProperty():Boolean[1]
{
   let result = execute(|Order.all()->filter(o|$o.product(%2015-08-26).name == 'ProductName1')->project([o|$o.product(%2015-08-26).id],['id']), businessSnapshotMilestoningUnionMap, testRuntime(), meta::relational::extension::relationalExtensions());
   assertEquals('select "unionalias_1"."ProductTableWithBusinessSnapshotMilestoningid_ProductTableWithBusinessSnapshotMilestoningid" as "id" from (select "root".prodFk as prodFk_0, null as prodFk_1, "root".id as "pk_0_0", null as "pk_0_1" from OrderTable as "root" UNION ALL select null as prodFk_0, "root".prodFk as prodFk_1, null as "pk_0_0", "root".id as "pk_0_1" from OrderTable as "root") as "unionBase" left outer join (select "root".snapshotDate as "snapshotDate_0", null as "snapshotDate_1", "root".id as id, "root".name as "ProductTableWithBusinessSnapshotMilestoningname_ProductTableWithBusinessSnapshotMilestoningname", "root".id as "ProductTableWithBusinessSnapshotMilestoningid_ProductTableWithBusinessSnapshotMilestoningid" from ProductTableWithBusinessSnapshotMilestoning as "root" where "root".snapshotDate = \'2015-08-26\' UNION ALL select null as "snapshotDate_0", "root".snapshotDate as "snapshotDate_1", "root".id as id, "root".name as "ProductTableWithBusinessSnapshotMilestoningname_ProductTableWithBusinessSnapshotMilestoningname", "root".id as "ProductTableWithBusinessSnapshotMilestoningid_ProductTableWithBusinessSnapshotMilestoningid" from ProductTableWithBusinessSnapshotMilestoning as "root" where "root".snapshotDate = \'2015-08-26\') as "unionalias_1" on (("unionBase".prodFk_0 = "unionalias_1".id or "unionBase".prodFk_1 = "unionalias_1".id) and (coalesce("unionalias_1"."snapshotDate_0", "unionalias_1"."snapshotDate_1") = \'2015-08-26\' or coalesce("unionalias_1"."snapshotDate_0", "unionalias_1"."snapshotDate_1") is null)) where "unionalias_1"."ProductTableWithBusinessSnapshotMilestoningname_ProductTableWithBusinessSnapshotMilestoningname" = \'ProductName1\'', $result->sqlRemoveFormatting());
   assertEquals([2, 2, 2, 2], $result.values.rows.get('id'));
}

function <<test.Test>> meta::relational::tests::milestoning::snapshot::testUnionQueryWithPropagationOnTemporalRoot():Boolean[1]
{
   let result = execute(|Product.all(%2015-08-26)->filter(p|$p.classification.description == 'STOCK DESC-V2')->project([p|$p.classification.type],['type']), businessSnapshotMilestoningUnionMap, testRuntime(), meta::relational::extension::relationalExtensions());
   assertEquals('select "unionalias_1"."ProductClassificationTableWithBusinessSnapshotMilestoningtype_ProductClassificationTableWithBusinessSnapshotMilestoningtype" as "type" from (select "root".snapshotDate as "snapshotDate_0", null as "snapshotDate_1", "root".type as type_0, null as type_1, "root".id as "pk_0_0", null as "pk_0_1" from ProductTableWithBusinessSnapshotMilestoning as "root" where "root".snapshotDate = \'2015-08-26\' UNION ALL select null as "snapshotDate_0", "root".snapshotDate as "snapshotDate_1", null as type_0, "root".type as type_1, null as "pk_0_0", "root".id as "pk_0_1" from ProductTableWithBusinessSnapshotMilestoning as "root" where "root".snapshotDate = \'2015-08-26\') as "unionBase" left outer join (select "root".snapshotDate as "snapshotDate_0", null as "snapshotDate_1", "root".type as type, "root".type_description as "ProductClassificationTableWithBusinessSnapshotMilestoningtype_description_ProductClassificationTableWithBusinessSnapshotMilestoningtype_description", "root".type as "ProductClassificationTableWithBusinessSnapshotMilestoningtype_ProductClassificationTableWithBusinessSnapshotMilestoningtype" from ProductClassificationTableWithBusinessSnapshotMilestoning as "root" where "root".snapshotDate = \'2015-08-26\' UNION ALL select null as "snapshotDate_0", "root".snapshotDate as "snapshotDate_1", "root".type as type, "root".type_description as "ProductClassificationTableWithBusinessSnapshotMilestoningtype_description_ProductClassificationTableWithBusinessSnapshotMilestoningtype_description", "root".type as "ProductClassificationTableWithBusinessSnapshotMilestoningtype_ProductClassificationTableWithBusinessSnapshotMilestoningtype" from ProductClassificationTableWithBusinessSnapshotMilestoning as "root" where "root".snapshotDate = \'2015-08-26\') as "unionalias_1" on (("unionBase".type_0 = "unionalias_1".type or "unionBase".type_1 = "unionalias_1".type) and (coalesce("unionalias_1"."snapshotDate_0", "unionalias_1"."snapshotDate_1") = \'2015-08-26\' or coalesce("unionalias_1"."snapshotDate_0", "unionalias_1"."snapshotDate_1") is null)) where "unionalias_1"."ProductClassificationTableWithBusinessSnapshotMilestoningtype_description_ProductClassificationTableWithBusinessSnapshotMilestoningtype_description" = \'STOCK DESC-V2\'', $result->sqlRemoveFormatting());
   assertEquals(['STOCK', 'STOCK', 'STOCK', 'STOCK'], $result.values.rows.get('type'));
}

function <<test.Test>> meta::relational::tests::milestoning::snapshot::testUnionQueryWithPropagationOnNonTemporalRootWithTemporalProperty():Boolean[1]
{
   let result = execute(|Order.all()->filter(o|$o.product(%2015-08-26).classification.description == 'STOCK DESC-V2')->project([o|$o.product(%2015-08-26).classification.type],['type']), businessSnapshotMilestoningUnionMap, testRuntime(), meta::relational::extension::relationalExtensions());
   assertEquals('select "unionalias_3"."ProductClassificationTableWithBusinessSnapshotMilestoningtype_ProductClassificationTableWithBusinessSnapshotMilestoningtype" as "type" from (select "root".prodFk as prodFk_0, null as prodFk_1, "root".id as "pk_0_0", null as "pk_0_1" from OrderTable as "root" UNION ALL select null as prodFk_0, "root".prodFk as prodFk_1, null as "pk_0_0", "root".id as "pk_0_1" from OrderTable as "root") as "unionBase" left outer join (select "root".snapshotDate as "snapshotDate_0", null as "snapshotDate_1", "root".id as id, "root".type as type_0, null as type_1 from ProductTableWithBusinessSnapshotMilestoning as "root" where "root".snapshotDate = \'2015-08-26\' UNION ALL select null as "snapshotDate_0", "root".snapshotDate as "snapshotDate_1", "root".id as id, null as type_0, "root".type as type_1 from ProductTableWithBusinessSnapshotMilestoning as "root" where "root".snapshotDate = \'2015-08-26\') as "unionalias_1" on (("unionBase".prodFk_0 = "unionalias_1".id or "unionBase".prodFk_1 = "unionalias_1".id) and (coalesce("unionalias_1"."snapshotDate_0", "unionalias_1"."snapshotDate_1") = \'2015-08-26\' or coalesce("unionalias_1"."snapshotDate_0", "unionalias_1"."snapshotDate_1") is null)) left outer join (select "root".snapshotDate as "snapshotDate_0", null as "snapshotDate_1", "root".type as type, "root".type_description as "ProductClassificationTableWithBusinessSnapshotMilestoningtype_description_ProductClassificationTableWithBusinessSnapshotMilestoningtype_description" from ProductClassificationTableWithBusinessSnapshotMilestoning as "root" where "root".snapshotDate = \'2015-08-26\' UNION ALL select null as "snapshotDate_0", "root".snapshotDate as "snapshotDate_1", "root".type as type, "root".type_description as "ProductClassificationTableWithBusinessSnapshotMilestoningtype_description_ProductClassificationTableWithBusinessSnapshotMilestoningtype_description" from ProductClassificationTableWithBusinessSnapshotMilestoning as "root" where "root".snapshotDate = \'2015-08-26\') as "unionalias_2" on (("unionalias_1".type_0 = "unionalias_2".type or "unionalias_1".type_1 = "unionalias_2".type) and (coalesce("unionalias_2"."snapshotDate_0", "unionalias_2"."snapshotDate_1") = \'2015-08-26\' or coalesce("unionalias_2"."snapshotDate_0", "unionalias_2"."snapshotDate_1") is null)) left outer join (select "unionalias_4".type as type, "unionalias_4"."ProductClassificationTableWithBusinessSnapshotMilestoningtype_ProductClassificationTableWithBusinessSnapshotMilestoningtype" as "ProductClassificationTableWithBusinessSnapshotMilestoningtype_ProductClassificationTableWithBusinessSnapshotMilestoningtype" from (select "root".snapshotDate as "snapshotDate_0", null as "snapshotDate_1", "root".type as type, "root".type as "ProductClassificationTableWithBusinessSnapshotMilestoningtype_ProductClassificationTableWithBusinessSnapshotMilestoningtype" from ProductClassificationTableWithBusinessSnapshotMilestoning as "root" where "root".snapshotDate = \'2015-08-26\' UNION ALL select null as "snapshotDate_0", "root".snapshotDate as "snapshotDate_1", "root".type as type, "root".type as "ProductClassificationTableWithBusinessSnapshotMilestoningtype_ProductClassificationTableWithBusinessSnapshotMilestoningtype" from ProductClassificationTableWithBusinessSnapshotMilestoning as "root" where "root".snapshotDate = \'2015-08-26\') as "unionalias_4" where coalesce("unionalias_4"."snapshotDate_0", "unionalias_4"."snapshotDate_1") = \'2015-08-26\' or coalesce("unionalias_4"."snapshotDate_0", "unionalias_4"."snapshotDate_1") is null) as "unionalias_3" on ("unionalias_1".type_0 = "unionalias_3".type or "unionalias_1".type_1 = "unionalias_3".type) where "unionalias_2"."ProductClassificationTableWithBusinessSnapshotMilestoningtype_description_ProductClassificationTableWithBusinessSnapshotMilestoningtype_description" = \'STOCK DESC-V2\'', $result->sqlRemoveFormatting());
   assertEquals(['STOCK', 'STOCK', 'STOCK', 'STOCK', 'STOCK', 'STOCK', 'STOCK', 'STOCK', 'STOCK', 'STOCK', 'STOCK', 'STOCK', 'STOCK', 'STOCK', 'STOCK', 'STOCK'], $result.values.rows.get('type'));
}

function <<test.Test>> meta::relational::tests::milestoning::snapshot::testAllVersionInRangeForBuisnessSnapshotMilestoning():Boolean[1]
{  
   let result = execute(|Product.allVersionsInRange(%2012-1-1, %2016-1-1)->filter(p|$p.name == 'ProductName1')->project([p|$p.id],['id']), businessSnapshotMilestoningMap, testRuntime(), meta::relational::extension::relationalExtensions());
   assertEquals('select "root".id as "id" from ProductTableWithBusinessSnapshotMilestoning as "root" where "root".name = \'ProductName1\' and "root".snapshotDate >= \'2012-01-01\' and "root".snapshotDate <= \'2016-01-01\'', $result->sqlRemoveFormatting());
   assertEquals(2, $result.values.rows.get('id'));
}

function <<test.Test>> meta::relational::tests::milestoning::snapshot::testBuisnessSnapshotRangeQueryOnProperty():Boolean[1]
{
   let result = execute(|Product.allVersions()->filter(x|$x.classificationAllVersionsInRange(%2015-1-1, %2015-9-1).type == 'STOCK')->project([x|$x.classificationAllVersionsInRange(%2015-1-1, %2015-9-1).type], ['type'])->distinct(), businessSnapshotMilestoningMap, testRuntime(), meta::relational::extension::relationalExtensions());
   assertSameSQL('select distinct "productclassificationtablewithbusinesssnapshotmilestoning_0".type as "type" from ProductTableWithBusinessSnapshotMilestoning as "root" left outer join ProductClassificationTableWithBusinessSnapshotMilestoning as "productclassificationtablewithbusinesssnapshotmilestoning_0" on ("root".type = "productclassificationtablewithbusinesssnapshotmilestoning_0".type and "productclassificationtablewithbusinesssnapshotmilestoning_0".snapshotDate >= \'2015-01-01\' and "productclassificationtablewithbusinesssnapshotmilestoning_0".snapshotDate <= \'2015-09-01\') where "productclassificationtablewithbusinesssnapshotmilestoning_0".type = \'STOCK\'', $result);
   assertSameElements(['STOCK'], $result.values.rows.getString('type'));
}

function <<test.Test>> meta::relational::tests::milestoning::rangeQuery::testBuisnessSnapshotRangeQueryOnRootAndProperty():Boolean[1]
{
   let result = execute(|Product.allVersionsInRange(%2015-1-1, %2015-9-1)->filter(x|$x.classificationAllVersionsInRange(%2015-1-1, %2015-9-1).type == 'STOCK')->project([x|$x.classificationAllVersionsInRange(%2015-1-1, %2015-9-1).type], ['type'])->distinct(), businessSnapshotMilestoningMap, testRuntime(), meta::relational::extension::relationalExtensions());
   assertSameSQL('select distinct "productclassificationtablewithbusinesssnapshotmilestoning_0".type as "type" from ProductTableWithBusinessSnapshotMilestoning as "root" left outer join ProductClassificationTableWithBusinessSnapshotMilestoning as "productclassificationtablewithbusinesssnapshotmilestoning_0" on ("root".type = "productclassificationtablewithbusinesssnapshotmilestoning_0".type and "productclassificationtablewithbusinesssnapshotmilestoning_0".snapshotDate >= \'2015-01-01\' and "productclassificationtablewithbusinesssnapshotmilestoning_0".snapshotDate <= \'2015-09-01\') where "productclassificationtablewithbusinesssnapshotmilestoning_0".type = \'STOCK\' and "root".snapshotDate >= \'2015-01-01\' and "root".snapshotDate <= \'2015-09-01\'', $result);
   assertSameElements(['STOCK'], $result.values.rows.getString('type'));
}

function <<test.BeforePackage>> meta::relational::tests::milestoning::snapshot::setUp():Runtime[1]
{
   initDatabase();
}
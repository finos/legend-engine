// Copyright 2023 Goldman Sachs
//
// Licensed under the Apache License, Version 2.0 (the "License");
// you may not use this file except in compliance with the License.
// You may obtain a copy of the License at
//
//      http://www.apache.org/licenses/LICENSE-2.0
//
// Unless required by applicable law or agreed to in writing, software
// distributed under the License is distributed on an "AS IS" BASIS,
// WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
// See the License for the specific language governing permissions and
// limitations under the License.

function meta::pure::tds::extensions::firstNotNull<T>(set:T[*]):T[0..1]
{
  $set->filter(v | $v != TDSNull)->first();
}

function <<functionType.NormalizeRequiredFunction>> meta::pure::tds::extensions::groupBy<T, U>(tds: TabularDataSet[1], columns:String[*], aggValues:  meta::pure::tds::AggregateValue<T,U>[*], specialAggregation: GroupBySpecialAggregation[1]): TabularDataSet[1]
{
  if ($specialAggregation->instanceOf(WavgAggregation) ,
  | $tds->groupBy($columns, $aggValues
                                              ->concatenate(agg('weightedQuantitySummation_1', r| $r.getNumber($specialAggregation->cast(@WavgAggregation).quantity) * $r.getNumber($specialAggregation->cast(@WavgAggregation).weight), z| $z->sum()))
                                              ->concatenate(agg('weightSummation_1', r| $r.getNumber($specialAggregation->cast(@WavgAggregation).weight), z| $z->sum())))
                                              ->extend([
                                                          col(row:TDSRow[1] | $row.getNumber('weightedQuantitySummation_1')/$row.getNumber('weightSummation_1'), $specialAggregation->cast(@WavgAggregation).columnId)
                                                        ])
                                              ->restrict($columns->concatenate($aggValues.name)->concatenate($specialAggregation->cast(@WavgAggregation).columnId));,
  | assert(false, 'Supported special aggregations include: wavg');
    $tds;)
}
// Copyright 2026 Goldman Sachs
//
// Licensed under the Apache License, Version 2.0 (the "License");
// you may not use this file except in compliance with the License.
// You may obtain a copy of the License at
//
//      http://www.apache.org/licenses/LICENSE-2.0
//
// Unless required by applicable law or agreed to in writing, software
// distributed under the License is distributed on an "AS IS" BASIS,
// WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
// See the License for the specific language governing permissions and
// limitations under the License.

import meta::pure::metamodel::relation::*;
import meta::pure::precisePrimitives::*;
import meta::pure::test::pct::*;
import meta::pure::functions::date::*;

function <<PCT.function>> meta::external::scenario::quant::vwap::monthlyVWAP(rel:Relation<(time:Date[1], symbol:String[1], open:Numeric(19,2)[1], high:Numeric(19,2)[1], low:Numeric(19,2)[1], close:Numeric(19,2)[1], volume:Integer[1])>[1]):Relation<(symbol:String[1], month:DateTime[1], closeByVolSum:Number[1], volumeSum:Integer[1], vwap:Float[1])>[1]
{
    $rel
      ->extend(~month:t|$t.time->cast(@DateTime)->timeBucket(1, DurationUnit.MONTHS))
      ->groupBy(
        ~[symbol, month],
        ~[
          closeByVolSum:x|($x.high + $x.low + $x.close) / 3 * $x.volume:y|$y->sum(),
          volumeSum:x|$x.volume:y|$y->sum()
        ]
      )->extend(~vwap:x|($x.closeByVolSum/$x.volumeSum))
       ->project(~[symbol:x|$x.symbol, month:x|$x.month, closeByVolSum:x|$x.closeByVolSum->cast(@Float)->round(2), volumeSum:x|$x.volumeSum, vwap:x|$x.vwap->round(2)]);
}

function <<PCT.test>> meta::external::scenario::quant::vwap::testMonthlyVWAP<T|m>(f:Function<{Function<{->T[m]}>[1]->T[m]}>[1]):Boolean[1]
{
    let expr = 
      {
        | #TDS
            time:Date[1], symbol:String[1], open:Numeric(19,2)[1], high:Numeric(19,2)[1], low:Numeric(19,2)[1], close:Numeric(19,2)[1], volume:Integer[1]
            2026-01-07T00:00:00.000000000+0000,AAPL,185.00,187.20,184.50,186.10,52000000
            2026-01-08T00:00:00.000000000+0000,AAPL,186.15,188.40,186.00,187.90,48500000
            2026-01-09T00:00:00.000000000+0000,AAPL,187.95,189.10,187.50,188.25,45000000
            2026-01-12T00:00:00.000000000+0000,AAPL,188.30,190.50,188.10,190.10,55200000
            2026-01-13T00:00:00.000000000+0000,AAPL,190.15,191.20,189.80,190.40,42000000
            2026-01-14T00:00:00.000000000+0000,AAPL,190.45,190.80,188.50,189.20,49000000
            2026-01-15T00:00:00.000000000+0000,AAPL,189.25,190.30,189.00,189.95,41500000
            2026-01-16T00:00:00.000000000+0000,AAPL,190.00,192.50,189.90,192.10,62000000
            2026-01-19T00:00:00.000000000+0000,AAPL,192.20,193.40,191.80,193.00,38000000
            2026-01-20T00:00:00.000000000+0000,AAPL,193.10,195.00,192.90,194.85,58000000
            2026-01-21T00:00:00.000000000+0000,AAPL,194.80,196.20,194.50,195.50,44000000
            2026-01-22T00:00:00.000000000+0000,AAPL,195.55,195.80,193.20,194.10,51000000
            2026-01-23T00:00:00.000000000+0000,AAPL,194.15,195.10,193.80,194.90,39000000
            2026-01-26T00:00:00.000000000+0000,AAPL,194.95,197.30,194.90,196.80,47000000
            2026-01-27T00:00:00.000000000+0000,AAPL,196.85,198.10,196.50,197.20,43000000
            2026-01-28T00:00:00.000000000+0000,AAPL,197.25,197.50,195.00,195.80,50500000
            2026-01-29T00:00:00.000000000+0000,AAPL,195.85,197.40,195.60,197.10,41000000
            2026-01-30T00:00:00.000000000+0000,AAPL,197.15,199.00,197.10,198.50,66000000
            2026-02-02T00:00:00.000000000+0000,AAPL,198.55,200.20,198.20,199.60,54000000
            2026-02-03T00:00:00.000000000+0000,AAPL,199.65,201.80,199.50,201.20,72000000
            2026-02-04T00:00:00.000000000+0000,AAPL,201.25,203.40,201.00,202.90,81000000
            2026-02-05T00:00:00.000000000+0000,AAPL,202.95,203.20,200.50,201.10,58000000
            2026-02-06T00:00:00.000000000+0000,AAPL,201.15,202.80,200.90,202.40,49000000
            2026-02-09T00:00:00.000000000+0000,AAPL,202.45,204.60,202.40,204.10,53000000
            2026-02-10T00:00:00.000000000+0000,AAPL,204.15,205.50,203.80,204.90,45000000
            2026-02-11T00:00:00.000000000+0000,AAPL,204.95,207.10,204.80,206.50,59000000
            2026-02-12T00:00:00.000000000+0000,AAPL,206.55,208.20,206.40,207.80,47000000
            2026-02-13T00:00:00.000000000+0000,AAPL,207.85,208.50,206.00,206.70,42000000
            2026-02-16T00:00:00.000000000+0000,AAPL,206.75,208.90,206.70,208.40,38000000
            2026-02-17T00:00:00.000000000+0000,AAPL,208.45,210.50,208.40,210.10,61000000
            2026-02-18T00:00:00.000000000+0000,AAPL,210.15,212.40,210.00,211.90,74000000
            2026-02-19T00:00:00.000000000+0000,AAPL,211.95,212.20,209.70,210.40,55000000
            2026-02-20T00:00:00.000000000+0000,AAPL,210.45,211.80,210.20,211.30,48000000
            2026-02-23T00:00:00.000000000+0000,AAPL,211.35,213.60,211.30,213.10,52000000
            2026-02-24T00:00:00.000000000+0000,AAPL,213.15,214.50,212.80,213.90,46000000
            2026-02-25T00:00:00.000000000+0000,AAPL,213.95,216.10,213.80,215.50,63000000
            2026-02-26T00:00:00.000000000+0000,AAPL,215.55,217.20,215.40,216.80,51000000
            2026-02-27T00:00:00.000000000+0000,AAPL,216.85,217.10,214.50,215.20,49000000
            2026-03-02T00:00:00.000000000+0000,AAPL,215.25,217.40,215.20,216.90,44000000
            2026-03-03T00:00:00.000000000+0000,AAPL,216.95,219.10,216.90,218.60,67000000
            2026-03-04T00:00:00.000000000+0000,AAPL,218.65,220.80,218.50,220.20,79000000
            2026-03-05T00:00:00.000000000+0000,AAPL,220.25,220.50,217.80,218.40,56000000
            2026-03-06T00:00:00.000000000+0000,AAPL,218.45,219.80,218.20,219.30,43000000
            2026-03-09T00:00:00.000000000+0000,AAPL,219.35,221.60,219.30,221.10,51000000
            2026-03-10T00:00:00.000000000+0000,AAPL,221.15,222.50,220.80,221.90,45000000
            2026-03-11T00:00:00.000000000+0000,AAPL,221.95,224.10,221.80,223.50,60000000
            2026-03-12T00:00:00.000000000+0000,AAPL,223.55,225.20,223.40,224.80,48000000
            2026-03-13T00:00:00.000000000+0000,AAPL,224.85,225.10,222.50,223.20,41000000
            2026-03-16T00:00:00.000000000+0000,AAPL,223.25,225.40,223.20,224.90,39000000
            2026-03-17T00:00:00.000000000+0000,AAPL,224.95,227.10,224.90,226.60,64000000
          #->meta::external::scenario::quant::vwap::monthlyVWAP();
      };

    let res =  $f->eval($expr);

    meta::pure::functions::relation::assertTdsEquivalent(
      #TDS
         symbol,month,closeByVolSum,volumeSum,vwap
         AAPL,2026-01-01T00:00:00.000+0000,168177755000.0,872700000,192.71
         AAPL,2026-02-01T00:00:00.000+0000,227944933333.33,1097000000,207.79
         AAPL,2026-03-01T00:00:00.000+0000,140986233333.33,637000000,221.33
      #,
      $res->sort([~symbol->ascending(), ~month->ascending()]),
      0.00001
    );
}
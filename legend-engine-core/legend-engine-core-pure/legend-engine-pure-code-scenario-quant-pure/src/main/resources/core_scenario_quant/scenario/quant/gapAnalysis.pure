// Copyright 2026 Goldman Sachs
//
// Licensed under the Apache License, Version 2.0 (the "License");
// you may not use this file except in compliance with the License.
// You may obtain a copy of the License at
//
//      http://www.apache.org/licenses/LICENSE-2.0
//
// Unless required by applicable law or agreed to in writing, software
// distributed under the License is distributed on an "AS IS" BASIS,
// WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
// See the License for the specific language governing permissions and
// limitations under the License.

import meta::pure::metamodel::relation::*;
import meta::pure::precisePrimitives::*;
import meta::pure::test::pct::*;
import meta::pure::functions::flow::*;

function <<PCT.function>> meta::external::scenario::quant::gap::gapAnalysis(rel:Relation<(time:Date[1], symbol:String[1], open:Numeric(19,2)[1], high:Numeric(19,2)[1], low:Numeric(19,2)[1], close:Numeric(19,2)[1], volume:Integer[1])>[1]):Relation<(symbol:String[1], time:Date[1], open:Numeric(19,2)[1], close:Numeric(19,2)[1], gapPercentage:Float[1])>[1]
{
    $rel
      ->select(~[symbol, time, open, close])
      ->extend(
        over(~symbol, ~time->ascending(), rows(-29,0)),
        ~gapPercentage : {p,w,r|(($r.open - coalesce($p->lag($r).close, $r.close)) / coalesce($p->lag($r).close, $r.close))*100.0}
      )
      ->project(
        ~[symbol:x|$x.symbol, time:x|$x.time, open:x|$x.open, close:x|$x.close, gapPercentage:x|$x.gapPercentage->round(2)]
      );
}

function <<PCT.test>> meta::external::scenario::quant::gap::testGapAnalysis<T|m>(f:Function<{Function<{->T[m]}>[1]->T[m]}>[1]):Boolean[1]
{
    let expr = 
      {
        | #TDS
            time:Date[1], symbol:String[1], open:Numeric(19,2)[1], high:Numeric(19,2)[1], low:Numeric(19,2)[1], close:Numeric(19,2)[1], volume:Integer[1]
              2026-01-07T09:30:00.000000000+0000,AAPL,190.50,192.10,190.10,191.45,55400200
              2026-01-08T09:30:00.000000000+0000,AAPL,191.45,193.50,191.20,192.80,48210300
              2026-01-09T09:30:00.000000000+0000,AAPL,195.00,196.40,194.50,195.90,72100450
              2026-01-10T09:30:00.000000000+0000,AAPL,195.90,197.00,195.10,196.25,41200300
              2026-01-11T09:30:00.000000000+0000,AAPL,196.25,196.80,194.20,194.50,39000100
              2026-01-12T09:30:00.000000000+0000,AAPL,192.10,193.00,190.50,191.15,65400900
              2026-01-13T09:30:00.000000000+0000,AAPL,191.15,192.45,191.00,192.10,43200500
              2026-01-14T09:30:00.000000000+0000,AAPL,192.10,194.20,192.00,193.85,44100200
              2026-01-15T09:30:00.000000000+0000,AAPL,193.85,195.50,193.50,195.10,50100800
              2026-01-16T09:30:00.000000000+0000,AAPL,197.50,199.10,197.20,198.45,88200300
              2026-01-17T09:30:00.000000000+0000,AAPL,198.45,200.50,198.40,200.10,92100400
              2026-01-18T09:30:00.000000000+0000,AAPL,200.10,201.20,199.50,200.45,55600700
              2026-01-19T09:30:00.000000000+0000,AAPL,200.45,202.00,200.20,201.50,47300200
              2026-01-20T09:30:00.000000000+0000,AAPL,198.50,199.50,196.10,197.05,71200500
              2026-01-21T09:30:00.000000000+0000,AAPL,197.05,198.20,196.80,197.90,38200400
              2026-01-22T09:30:00.000000000+0000,AAPL,197.90,199.00,197.50,198.60,41000600
              2026-01-23T09:30:00.000000000+0000,AAPL,198.60,199.80,198.20,199.25,45000700
              2026-01-24T09:30:00.000000000+0000,AAPL,199.25,200.50,199.00,200.15,49000800
              2026-01-25T09:30:00.000000000+0000,AAPL,203.40,205.10,203.20,204.60,95400200
              2026-01-26T09:30:00.000000000+0000,AAPL,204.60,205.80,204.00,205.15,53200100
              2026-01-27T09:30:00.000000000+0000,AAPL,205.15,206.50,204.80,206.00,47100300
              2026-01-28T09:30:00.000000000+0000,AAPL,206.00,207.20,205.80,206.75,42500600
              2026-01-29T09:30:00.000000000+0000,AAPL,206.75,207.80,206.20,207.10,39800400
              2026-01-30T09:30:00.000000000+0000,AAPL,204.00,205.20,203.10,204.25,68200500
              2026-01-31T09:30:00.000000000+0000,AAPL,204.25,205.50,204.00,205.00,41200300
              2026-02-01T09:30:00.000000000+0000,AAPL,205.00,206.20,204.80,205.85,38500200
              2026-02-02T09:30:00.000000000+0000,AAPL,205.85,207.00,205.50,206.40,40200900
              2026-02-03T09:30:00.000000000+0000,AAPL,206.40,207.50,206.00,207.15,43100400
              2026-02-04T09:30:00.000000000+0000,AAPL,209.50,211.20,209.10,210.60,99800500
              2026-02-05T09:30:00.000000000+0000,AAPL,210.60,211.80,210.20,211.45,56300400
              2026-02-06T09:30:00.000000000+0000,AAPL,211.45,212.50,211.00,212.10,48200300
              2026-02-07T09:30:00.000000000+0000,AAPL,212.10,213.20,211.80,212.85,44100200
              2026-02-08T09:30:00.000000000+0000,AAPL,212.85,214.00,212.50,213.60,49000100
              2026-02-09T09:30:00.000000000+0000,AAPL,210.20,211.50,208.50,209.45,77400600
              2026-02-10T09:30:00.000000000+0000,AAPL,209.45,210.80,209.10,210.20,50200300
              2026-02-11T09:30:00.000000000+0000,AAPL,210.20,211.40,209.80,211.00,42100400
              2026-02-12T09:30:00.000000000+0000,AAPL,211.00,212.20,210.50,211.85,43900200
              2026-02-13T09:30:00.000000000+0000,AAPL,211.85,213.00,211.50,212.60,45800100
              2026-02-14T09:30:00.000000000+0000,AAPL,215.10,217.00,214.80,216.45,89100400
              2026-02-15T09:30:00.000000000+0000,AAPL,216.45,217.80,216.00,217.20,54200300
              2026-02-16T09:30:00.000000000+0000,AAPL,217.20,218.50,216.80,218.10,49100200
              2026-02-17T09:30:00.000000000+0000,AAPL,218.10,219.40,217.80,219.00,46200100
              2026-02-18T09:30:00.000000000+0000,AAPL,219.00,220.20,218.60,219.85,48500400
              2026-02-19T09:30:00.000000000+0000,AAPL,216.50,217.80,214.20,215.40,79200300
              2026-02-20T09:30:00.000000000+0000,AAPL,215.40,216.90,215.00,216.20,51200100
              2026-02-21T09:30:00.000000000+0000,AAPL,216.20,217.50,215.80,217.10,45300400
              2026-02-22T09:30:00.000000000+0000,AAPL,217.10,218.40,216.80,218.00,42100600
              2026-02-23T09:30:00.000000000+0000,AAPL,218.00,219.20,217.60,218.85,44800200
              2026-02-24T09:30:00.000000000+0000,AAPL,222.00,224.50,221.80,223.70,110200400
              2026-02-25T09:30:00.000000000+0000,AAPL,223.70,225.10,223.20,224.60,61200300
            #->meta::external::scenario::quant::gap::gapAnalysis();
      };

    let res =  $f->eval($expr);

    meta::pure::functions::relation::assertTdsEquivalent(
      #TDS
         symbol,time,open,close,gapPercentage
         AAPL,2026-01-07T09:30:00.000+0000,190.50,191.45,-0.5
         AAPL,2026-01-08T09:30:00.000+0000,191.45,192.80,0.0
         AAPL,2026-01-09T09:30:00.000+0000,195.00,195.90,1.14
         AAPL,2026-01-10T09:30:00.000+0000,195.90,196.25,0.0
         AAPL,2026-01-11T09:30:00.000+0000,196.25,194.50,0.0
         AAPL,2026-01-12T09:30:00.000+0000,192.10,191.15,-1.23
         AAPL,2026-01-13T09:30:00.000+0000,191.15,192.10,0.0
         AAPL,2026-01-14T09:30:00.000+0000,192.10,193.85,0.0
         AAPL,2026-01-15T09:30:00.000+0000,193.85,195.10,0.0
         AAPL,2026-01-16T09:30:00.000+0000,197.50,198.45,1.23
         AAPL,2026-01-17T09:30:00.000+0000,198.45,200.10,0.0
         AAPL,2026-01-18T09:30:00.000+0000,200.10,200.45,0.0
         AAPL,2026-01-19T09:30:00.000+0000,200.45,201.50,0.0
         AAPL,2026-01-20T09:30:00.000+0000,198.50,197.05,-1.49
         AAPL,2026-01-21T09:30:00.000+0000,197.05,197.90,0.0
         AAPL,2026-01-22T09:30:00.000+0000,197.90,198.60,0.0
         AAPL,2026-01-23T09:30:00.000+0000,198.60,199.25,0.0
         AAPL,2026-01-24T09:30:00.000+0000,199.25,200.15,0.0
         AAPL,2026-01-25T09:30:00.000+0000,203.40,204.60,1.62
         AAPL,2026-01-26T09:30:00.000+0000,204.60,205.15,0.0
         AAPL,2026-01-27T09:30:00.000+0000,205.15,206.00,0.0
         AAPL,2026-01-28T09:30:00.000+0000,206.00,206.75,0.0
         AAPL,2026-01-29T09:30:00.000+0000,206.75,207.10,0.0
         AAPL,2026-01-30T09:30:00.000+0000,204.00,204.25,-1.5
         AAPL,2026-01-31T09:30:00.000+0000,204.25,205.00,0.0
         AAPL,2026-02-01T09:30:00.000+0000,205.00,205.85,0.0
         AAPL,2026-02-02T09:30:00.000+0000,205.85,206.40,0.0
         AAPL,2026-02-03T09:30:00.000+0000,206.40,207.15,0.0
         AAPL,2026-02-04T09:30:00.000+0000,209.50,210.60,1.13
         AAPL,2026-02-05T09:30:00.000+0000,210.60,211.45,0.0
         AAPL,2026-02-06T09:30:00.000+0000,211.45,212.10,0.0
         AAPL,2026-02-07T09:30:00.000+0000,212.10,212.85,0.0
         AAPL,2026-02-08T09:30:00.000+0000,212.85,213.60,0.0
         AAPL,2026-02-09T09:30:00.000+0000,210.20,209.45,-1.59
         AAPL,2026-02-10T09:30:00.000+0000,209.45,210.20,0.0
         AAPL,2026-02-11T09:30:00.000+0000,210.20,211.00,0.0
         AAPL,2026-02-12T09:30:00.000+0000,211.00,211.85,0.0
         AAPL,2026-02-13T09:30:00.000+0000,211.85,212.60,0.0
         AAPL,2026-02-14T09:30:00.000+0000,215.10,216.45,1.18
         AAPL,2026-02-15T09:30:00.000+0000,216.45,217.20,0.0
         AAPL,2026-02-16T09:30:00.000+0000,217.20,218.10,0.0
         AAPL,2026-02-17T09:30:00.000+0000,218.10,219.00,0.0
         AAPL,2026-02-18T09:30:00.000+0000,219.00,219.85,0.0
         AAPL,2026-02-19T09:30:00.000+0000,216.50,215.40,-1.52
         AAPL,2026-02-20T09:30:00.000+0000,215.40,216.20,0.0
         AAPL,2026-02-21T09:30:00.000+0000,216.20,217.10,0.0
         AAPL,2026-02-22T09:30:00.000+0000,217.10,218.00,0.0
         AAPL,2026-02-23T09:30:00.000+0000,218.00,218.85,0.0
         AAPL,2026-02-24T09:30:00.000+0000,222.00,223.70,1.44
         AAPL,2026-02-25T09:30:00.000+0000,223.70,224.60,0.0
       #,
       $res->sort([~symbol->ascending(), ~time->ascending()]),
       0.00001
    );
}
// Copyright 2026 Goldman Sachs
//
// Licensed under the Apache License, Version 2.0 (the "License");
// you may not use this file except in compliance with the License.
// You may obtain a copy of the License at
//
//      http://www.apache.org/licenses/LICENSE-2.0
//
// Unless required by applicable law or agreed to in writing, software
// distributed under the License is distributed on an "AS IS" BASIS,
// WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
// See the License for the specific language governing permissions and
// limitations under the License.

import meta::pure::metamodel::relation::*;
import meta::pure::precisePrimitives::*;
import meta::pure::test::pct::*;
import meta::pure::functions::flow::*;

function <<PCT.function>> meta::external::scenario::quant::volatility::close::annualizedRolling10DaysVolatility(rel:Relation<(time:Date[1], symbol:String[1], open:Numeric(19,2)[1], high:Numeric(19,2)[1], low:Numeric(19,2)[1], close:Numeric(19,2)[1], volume:Integer[1])>[1]):Relation<(symbol:String[1], time:Date[1], close:Numeric(19,2)[1], logReturn:Float[1], rollingVolatility:Number[1])>[1]
{
    // meta::external::scenario::quant::return::logReturn::logReturn($rel)->extend(
    //   over(~symbol, ~time->ascending(), rows(-9,0)),
    //   ~rollingVolatility : {p,w,r|$r.logReturn}: y|($y->stdDevPopulation()*sqrt(252))->cast(@Float)->round(10)
    // );

    // Volatility is the standard deviation of returns
    meta::external::scenario::quant::return::logReturn::logReturn($rel)->extend(
      over(~symbol, ~time->ascending(), rows(-9,0)),
      ~rollingVolatility : {p,w,r|$r.logReturn}: y|$y->stdDevPopulation()
    )->project(
          ~[symbol:x|$x.symbol, time:x|$x.time, close:x|$x.close, logReturn:x|$x.logReturn, rollingVolatility:x|($x.rollingVolatility*sqrt(252))->cast(@Float)->round(10)]
    );
}


function <<PCT.test>> meta::external::scenario::quant::volatility::close::testAnnualizedRolling10DaysVolatility<T|m>(f:Function<{Function<{->T[m]}>[1]->T[m]}>[1]):Boolean[1]
{
    let expr = 
      {
        | #TDS
            time:Date[1], symbol:String[1], open:Numeric(19,2)[1], high:Numeric(19,2)[1], low:Numeric(19,2)[1], close:Numeric(19,2)[1], volume:Integer[1]
            2026-01-01T00:00:00.000000000+0000,AAPL,150.00,152.50,149.50,151.20,1500000
            2026-01-02T00:00:00.000000000+0000,AAPL,151.20,151.80,150.10,150.50,1200000
            2026-01-03T00:00:00.000000000+0000,AAPL,150.50,151.20,149.80,150.90,1100000
            2026-01-04T00:00:00.000000000+0000,AAPL,150.90,151.50,150.20,151.10,1300000
            2026-01-05T00:00:00.000000000+0000,AAPL,151.10,152.10,151.00,151.80,1450000
            2026-01-06T00:00:00.000000000+0000,AAPL,151.80,152.30,151.50,152.00,1150000
            2026-01-07T00:00:00.000000000+0000,AAPL,152.00,152.40,151.70,151.90,1050000
            2026-01-08T00:00:00.000000000+0000,AAPL,151.90,152.20,151.30,151.50,950000
            2026-01-09T00:00:00.000000000+0000,AAPL,151.50,152.00,151.10,151.70,1100000
            2026-01-10T00:00:00.000000000+0000,AAPL,151.70,152.50,151.60,152.10,1250000
            2026-01-11T00:00:00.000000000+0000,AAPL,152.10,152.80,151.90,152.40,1300000
            2026-01-12T00:00:00.000000000+0000,AAPL,152.40,153.10,152.20,152.80,1400000
            2026-01-13T00:00:00.000000000+0000,AAPL,152.80,153.00,152.50,152.60,1100000
            2026-01-14T00:00:00.000000000+0000,AAPL,152.60,153.20,152.40,153.00,1200000
            2026-01-15T00:00:00.000000000+0000,AAPL,153.00,153.50,152.80,153.30,1350000
            2026-01-16T00:00:00.000000000+0000,AAPL,153.30,153.80,153.10,153.50,1250000
            2026-01-17T00:00:00.000000000+0000,AAPL,153.50,154.10,153.40,153.90,1450000
            2026-01-18T00:00:00.000000000+0000,AAPL,153.90,154.30,153.70,154.00,1150000
            2026-01-19T00:00:00.000000000+0000,AAPL,154.00,154.50,153.80,154.20,1200000
            2026-01-20T00:00:00.000000000+0000,AAPL,154.20,154.80,154.00,154.50,1300000
            2026-01-21T00:00:00.000000000+0000,AAPL,154.50,154.90,154.30,154.70,1100000
            2026-01-22T00:00:00.000000000+0000,AAPL,154.70,155.20,154.50,155.00,1250000
            2026-01-23T00:00:00.000000000+0000,AAPL,155.00,155.50,154.80,155.30,1400000
            2026-01-24T00:00:00.000000000+0000,AAPL,155.30,155.80,155.10,155.60,1350000
            2026-01-25T00:00:00.000000000+0000,AAPL,155.60,156.10,155.40,155.90,1500000
            2026-01-26T00:00:00.000000000+0000,AAPL,155.90,156.50,155.70,156.30,1600000
            2026-01-27T00:00:00.000000000+0000,AAPL,156.30,157.00,156.00,156.80,1800000
            2026-01-28T00:00:00.000000000+0000,AAPL,156.80,165.50,155.50,162.20,4500000
            2026-01-29T00:00:00.000000000+0000,AAPL,162.20,175.00,160.00,171.10,6200000
            2026-01-30T00:00:00.000000000+0000,AAPL,171.10,182.50,168.00,178.50,7500000
            2026-01-31T00:00:00.000000000+0000,AAPL,178.50,172.00,155.00,158.80,8900000
            2026-02-01T00:00:00.000000000+0000,AAPL,158.80,162.50,154.20,156.50,5400000
            2026-02-02T00:00:00.000000000+0000,AAPL,156.50,158.20,153.50,155.40,4200000
            2026-02-03T00:00:00.000000000+0000,AAPL,155.40,156.80,154.20,155.90,3100000
            2026-02-04T00:00:00.000000000+0000,AAPL,155.90,156.50,154.80,155.20,2200000
            2026-02-05T00:00:00.000000000+0000,AAPL,155.20,155.80,154.50,155.40,1800000
            2026-02-06T00:00:00.000000000+0000,AAPL,155.40,156.00,155.10,155.70,1600000
            2026-02-07T00:00:00.000000000+0000,AAPL,155.70,156.20,155.40,155.80,1400000
            2026-02-08T00:00:00.000000000+0000,AAPL,155.80,156.30,155.60,156.10,1300000
            2026-02-09T00:00:00.000000000+0000,AAPL,156.10,156.60,155.90,156.40,1200000
            2026-02-10T00:00:00.000000000+0000,AAPL,156.40,156.90,156.20,156.70,1150000
            2026-02-11T00:00:00.000000000+0000,AAPL,156.70,157.20,156.50,157.00,1100000
            2026-02-12T00:00:00.000000000+0000,AAPL,157.00,157.50,156.80,157.30,1050000
            2026-02-13T00:00:00.000000000+0000,AAPL,157.30,157.80,157.10,157.60,1000000
            2026-02-14T00:00:00.000000000+0000,AAPL,157.60,158.10,157.40,157.90,950000
            2026-02-15T00:00:00.000000000+0000,AAPL,157.90,158.40,157.70,158.20,900000
            2026-02-16T00:00:00.000000000+0000,AAPL,158.20,158.70,158.00,158.50,850000
            2026-02-17T00:00:00.000000000+0000,AAPL,158.50,159.00,158.30,158.80,800000
            2026-02-18T00:00:00.000000000+0000,AAPL,158.80,159.30,158.60,159.10,750000
            2026-02-19T00:00:00.000000000+0000,AAPL,159.10,159.60,158.90,159.40,700000
        #->meta::external::scenario::quant::volatility::close::annualizedRolling10DaysVolatility();
      };

    let res =  $f->eval($expr);

    meta::pure::functions::relation::assertTdsEquivalent(
      #TDS
         symbol,time,close,logReturn,rollingVolatility
         AAPL,2026-01-01T00:00:00.000+0000,151.20,0.0,0.0
         AAPL,2026-01-02T00:00:00.000+0000,150.50,-0.0046403795,0.0368318704
         AAPL,2026-01-03T00:00:00.000+0000,150.90,0.0026542816,0.0478553192
         AAPL,2026-01-04T00:00:00.000+0000,151.10,0.0013245035,0.0436355655
         AAPL,2026-01-05T00:00:00.000+0000,151.80,0.0046219957,0.0494706979
         AAPL,2026-01-06T00:00:00.000+0000,152.00,0.0013166559,0.0452668707
         AAPL,2026-01-07T00:00:00.000+0000,151.90,-0.0006581112,0.0427705196
         AAPL,2026-01-08T00:00:00.000+0000,151.50,-0.0026367847,0.0435912413
         AAPL,2026-01-09T00:00:00.000+0000,151.70,0.0013192614,0.0414443985
         AAPL,2026-01-10T00:00:00.000+0000,152.10,0.0026333129,0.0407723043
         AAPL,2026-01-11T00:00:00.000+0000,152.40,0.001970444,0.0411278641
         AAPL,2026-01-12T00:00:00.000+0000,152.80,0.0026212335,0.0299968699
         AAPL,2026-01-13T00:00:00.000+0000,152.60,-0.0013097579,0.0320767522
         AAPL,2026-01-14T00:00:00.000+0000,153.00,0.0026178026,0.0328658663
         AAPL,2026-01-15T00:00:00.000+0000,153.30,0.0019588645,0.0280779173
         AAPL,2026-01-16T00:00:00.000+0000,153.50,0.0013037811,0.0280741319
         AAPL,2026-01-17T00:00:00.000+0000,153.90,0.0026024738,0.0275635886
         AAPL,2026-01-18T00:00:00.000+0000,154.00,0.0006495616,0.0187431212
         AAPL,2026-01-19T00:00:00.000+0000,154.20,0.0012978587,0.0187525305
         AAPL,2026-01-20T00:00:00.000+0000,154.50,0.0019436352,0.0181032806
         AAPL,2026-01-21T00:00:00.000+0000,154.70,0.0012936613,0.0180085391
         AAPL,2026-01-22T00:00:00.000+0000,155.00,0.0019373593,0.0172103666
         AAPL,2026-01-23T00:00:00.000+0000,155.30,0.0019336133,0.0093273142
         AAPL,2026-01-24T00:00:00.000+0000,155.60,0.0019298816,0.0082327312
         AAPL,2026-01-25T00:00:00.000+0000,155.90,0.0019261644,0.008206758
         AAPL,2026-01-26T00:00:00.000+0000,156.30,0.0025624614,0.008905153
         AAPL,2026-01-27T00:00:00.000+0000,156.80,0.0031938705,0.0105320655
         AAPL,2026-01-28T00:00:00.000+0000,162.20,0.0338590338,0.1519428224
         AAPL,2026-01-29T00:00:00.000+0000,171.10,0.0534180392,0.2729083034
         AAPL,2026-01-30T00:00:00.000+0000,178.50,0.0423404204,0.307040327
         AAPL,2026-01-31T00:00:00.000+0000,158.80,-0.1169430525,0.6997684124
         AAPL,2026-02-01T00:00:00.000+0000,156.50,-0.0145895388,0.7045819347
         AAPL,2026-02-02T00:00:00.000+0000,155.40,-0.0070535721,0.7055692398
         AAPL,2026-02-03T00:00:00.000+0000,155.90,0.0032123381,0.7056811125
         AAPL,2026-02-04T00:00:00.000+0000,155.20,-0.0045001683,0.7059468759
         AAPL,2026-02-05T00:00:00.000+0000,155.40,0.0012878302,0.7058358971
         AAPL,2026-02-06T00:00:00.000+0000,155.70,0.0019286409,0.7056912427
         AAPL,2026-02-07T00:00:00.000+0000,155.80,0.0006420546,0.6820273413
         AAPL,2026-02-08T00:00:00.000+0000,156.10,0.0019236941,0.6133649119
         AAPL,2026-02-09T00:00:00.000+0000,156.40,0.0019200006,0.555269666
         AAPL,2026-02-10T00:00:00.000+0000,156.70,0.0019163213,0.0858260285
         AAPL,2026-02-11T00:00:00.000+0000,157.00,0.001912656,0.0501528864
         AAPL,2026-02-12T00:00:00.000+0000,157.30,0.0019090047,0.0317310934
         AAPL,2026-02-13T00:00:00.000+0000,157.60,0.0019053673,0.0302332922
         AAPL,2026-02-14T00:00:00.000+0000,157.90,0.0019017438,0.0064527653
         AAPL,2026-02-15T00:00:00.000+0000,158.20,0.0018981341,0.0060536797
         AAPL,2026-02-16T00:00:00.000+0000,158.50,0.001894538,0.0060355477
         AAPL,2026-02-17T00:00:00.000+0000,158.80,0.0018909555,0.0001658598
         AAPL,2026-02-18T00:00:00.000+0000,159.10,0.0018873866,0.0001652287
         AAPL,2026-02-19T00:00:00.000+0000,159.40,0.001883831,0.0001646015
      #,
      $res->sort([~symbol->ascending(), ~time->ascending()]),
      0.00001
    );
}
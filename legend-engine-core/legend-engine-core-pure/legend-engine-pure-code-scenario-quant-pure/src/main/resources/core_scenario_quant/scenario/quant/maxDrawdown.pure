// Copyright 2026 Goldman Sachs
//
// Licensed under the Apache License, Version 2.0 (the "License");
// you may not use this file except in compliance with the License.
// You may obtain a copy of the License at
//
//      http://www.apache.org/licenses/LICENSE-2.0
//
// Unless required by applicable law or agreed to in writing, software
// distributed under the License is distributed on an "AS IS" BASIS,
// WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
// See the License for the specific language governing permissions and
// limitations under the License.

import meta::pure::metamodel::relation::*;
import meta::pure::precisePrimitives::*;
import meta::pure::test::pct::*;
import meta::pure::functions::date::*;

function <<PCT.function>> meta::external::scenario::quant::maxDrawDown::maxDrawDown(rel:Relation<(time:Date[1], symbol:String[1], open:Numeric(19,2)[1], high:Numeric(19,2)[1], low:Numeric(19,2)[1], close:Numeric(19,2)[1], volume:Integer[1])>[1]):Relation<(symbol:String[1],maxDrawdown:Float[1])>[1]
{
    $rel->extend(
      over(~symbol, ~time->ascending()),
      ~maxClose : {p,w,r|$r.high} : y|$y->max()
    )->groupBy(
      ~symbol,
      ~maxDrawdown : {r|(($r.low - $r.maxClose->toOne())/$r.maxClose->toOne())*100.0} : y|$y->min()->toOne()->round(2)
    )
}

function <<PCT.test>> meta::external::scenario::quant::maxDrawDown::testMaxDrawDown<T|m>(f:Function<{Function<{->T[m]}>[1]->T[m]}>[1]):Boolean[1]
{
    let expr = 
      {
        | #TDS
            time:Date[1], symbol:String[1], open:Numeric(19,2)[1], high:Numeric(19,2)[1], low:Numeric(19,2)[1], close:Numeric(19,2)[1], volume:Integer[1]
            2026-01-07T00:00:00.000000000+0000,AAPL,150.00,152.50,149.50,152.00,500000
            2026-01-07T01:00:00.000000000+0000,AAPL,152.00,154.20,151.80,153.50,480000
            2026-01-07T02:00:00.000000000+0000,AAPL,153.50,155.00,153.00,154.80,450000
            2026-01-07T03:00:00.000000000+0000,AAPL,154.80,158.00,154.50,157.20,600000
            2026-01-07T04:00:00.000000000+0000,AAPL,157.20,160.50,157.00,160.00,700000
            2026-01-07T05:00:00.000000000+0000,AAPL,160.00,162.00,159.50,161.50,550000
            2026-01-07T06:00:00.000000000+0000,AAPL,161.50,163.40,161.00,163.00,520000
            2026-01-07T07:00:00.000000000+0000,AAPL,163.00,165.00,162.80,164.50,800000
            2026-01-07T08:00:00.000000000+0000,AAPL,164.50,166.00,164.00,165.80,900000
            2026-01-07T09:00:00.000000000+0000,AAPL,165.80,165.90,162.00,162.50,1100000
            2026-01-07T10:00:00.000000000+0000,AAPL,162.50,163.00,158.50,159.00,1200000
            2026-01-07T11:00:00.000000000+0000,AAPL,159.00,160.00,155.00,155.50,1300000
            2026-01-07T12:00:00.000000000+0000,AAPL,155.50,156.00,152.00,152.50,1000000
            2026-01-07T13:00:00.000000000+0000,AAPL,152.50,153.50,148.00,148.50,1500000
            2026-01-07T14:00:00.000000000+0000,AAPL,148.50,149.00,145.00,146.00,1600000
            2026-01-07T15:00:00.000000000+0000,AAPL,146.00,147.00,142.00,142.50,1800000
            2026-01-07T16:00:00.000000000+0000,AAPL,142.50,143.00,140.00,141.00,2000000
            2026-01-07T17:00:00.000000000+0000,AAPL,141.00,142.50,140.50,142.00,900000
            2026-01-07T18:00:00.000000000+0000,AAPL,142.00,144.00,141.80,143.50,850000
            2026-01-07T19:00:00.000000000+0000,AAPL,143.50,145.00,143.00,144.80,700000
            2026-01-07T20:00:00.000000000+0000,AAPL,144.80,146.50,144.50,146.00,650000
            2026-01-07T21:00:00.000000000+0000,AAPL,146.00,147.80,145.80,147.20,600000
            2026-01-07T22:00:00.000000000+0000,AAPL,147.20,149.00,147.00,148.50,550000
            2026-01-07T23:00:00.000000000+0000,AAPL,148.50,150.20,148.20,149.80,500000
            2026-01-08T00:00:00.000000000+0000,AAPL,149.80,151.50,149.50,151.00,480000
            2026-01-08T01:00:00.000000000+0000,AAPL,151.00,152.50,150.80,152.20,450000
            2026-01-08T02:00:00.000000000+0000,AAPL,152.20,153.80,152.00,153.50,430000
            2026-01-08T03:00:00.000000000+0000,AAPL,153.50,155.00,153.20,154.80,410000
            2026-01-08T04:00:00.000000000+0000,AAPL,154.80,156.20,154.50,155.80,400000
            2026-01-08T05:00:00.000000000+0000,AAPL,155.80,157.50,155.50,157.00,420000
            2026-01-08T06:00:00.000000000+0000,AAPL,157.00,158.80,156.80,158.40,440000
            2026-01-08T07:00:00.000000000+0000,AAPL,158.40,160.00,158.20,159.50,460000
            2026-01-08T08:00:00.000000000+0000,AAPL,159.50,161.20,159.20,160.80,480000
            2026-01-08T09:00:00.000000000+0000,AAPL,160.80,162.50,160.50,162.00,500000
            2026-01-08T10:00:00.000000000+0000,AAPL,162.00,163.80,161.80,163.20,520000
            2026-01-08T11:00:00.000000000+0000,AAPL,163.20,164.50,163.00,164.20,540000
            2026-01-08T12:00:00.000000000+0000,AAPL,164.20,165.50,164.00,165.20,560000
            2026-01-08T13:00:00.000000000+0000,AAPL,165.20,166.80,165.00,166.50,580000
            2026-01-08T14:00:00.000000000+0000,AAPL,166.50,168.00,166.20,167.50,600000
            2026-01-08T15:00:00.000000000+0000,AAPL,167.50,169.20,167.20,168.80,620000
            2026-01-08T16:00:00.000000000+0000,AAPL,168.80,170.50,168.50,170.00,640000
            2026-01-08T17:00:00.000000000+0000,AAPL,170.00,171.80,169.80,171.20,660000
            2026-01-08T18:00:00.000000000+0000,AAPL,171.20,172.50,171.00,172.20,680000
            2026-01-08T19:00:00.000000000+0000,AAPL,172.20,173.80,172.00,173.50,700000
            2026-01-08T20:00:00.000000000+0000,AAPL,173.50,175.00,173.20,174.80,720000
            2026-01-08T21:00:00.000000000+0000,AAPL,174.80,176.20,174.50,175.80,740000
            2026-01-08T22:00:00.000000000+0000,AAPL,175.80,177.50,175.50,177.00,760000
            2026-01-08T23:00:00.000000000+0000,AAPL,177.00,178.80,176.80,178.40,780000
            2026-01-09T00:00:00.000000000+0000,AAPL,178.40,180.00,178.20,179.50,800000
            2026-01-09T01:00:00.000000000+0000,AAPL,179.50,181.20,179.20,180.80,820000
          #->meta::external::scenario::quant::maxDrawDown::maxDrawDown();
      };

    let res =  $f->eval($expr);

    meta::pure::functions::relation::assertTdsEquivalent(
      #TDS
         symbol,maxDrawdown
         AAPL,-15.66
      #,
      $res,
      0.00001
    );
}